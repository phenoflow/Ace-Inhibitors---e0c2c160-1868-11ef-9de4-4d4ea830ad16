# Tim Doran, Evangelos Kontopantelis, Jose M Valderas, Stephen Campbell, Martin Roland, Chris Salisbury, David Reeves, 2024.

import sys, csv, re

codes = [{"code":"6307001","system":"gprdproduct"},{"code":"4494009","system":"gprdproduct"},{"code":"2409002","system":"gprdproduct"},{"code":"11637001","system":"gprdproduct"},{"code":"2213011","system":"gprdproduct"},{"code":"2899002","system":"gprdproduct"},{"code":"7073001","system":"gprdproduct"},{"code":"932001","system":"gprdproduct"},{"code":"1344010","system":"gprdproduct"},{"code":"2213009","system":"gprdproduct"},{"code":"2863010","system":"gprdproduct"},{"code":"5071009","system":"gprdproduct"},{"code":"5366002","system":"gprdproduct"},{"code":"1702003","system":"gprdproduct"},{"code":"2862011","system":"gprdproduct"},{"code":"5023009","system":"gprdproduct"},{"code":"3723010","system":"gprdproduct"},{"code":"5070009","system":"gprdproduct"},{"code":"2412001","system":"gprdproduct"},{"code":"2901001","system":"gprdproduct"},{"code":"910010","system":"gprdproduct"},{"code":"5697009","system":"gprdproduct"},{"code":"830011","system":"gprdproduct"},{"code":"4233001","system":"gprdproduct"},{"code":"582010","system":"gprdproduct"},{"code":"5032009","system":"gprdproduct"},{"code":"3995009","system":"gprdproduct"},{"code":"6114009","system":"gprdproduct"},{"code":"4978002","system":"gprdproduct"},{"code":"3075009","system":"gprdproduct"},{"code":"3135010","system":"gprdproduct"},{"code":"289010","system":"gprdproduct"},{"code":"4840001","system":"gprdproduct"},{"code":"291011","system":"gprdproduct"},{"code":"1820009","system":"gprdproduct"},{"code":"4735001","system":"gprdproduct"},{"code":"10340001","system":"gprdproduct"},{"code":"2411003","system":"gprdproduct"},{"code":"1200010","system":"gprdproduct"},{"code":"10603001","system":"gprdproduct"},{"code":"3653010","system":"gprdproduct"},{"code":"499010","system":"gprdproduct"},{"code":"1700001","system":"gprdproduct"},{"code":"289009","system":"gprdproduct"},{"code":"4988001","system":"gprdproduct"},{"code":"5693009","system":"gprdproduct"},{"code":"4174001","system":"gprdproduct"},{"code":"6307002","system":"gprdproduct"},{"code":"910011","system":"gprdproduct"},{"code":"721011","system":"gprdproduct"},{"code":"2411001","system":"gprdproduct"},{"code":"6164001","system":"gprdproduct"},{"code":"5033009","system":"gprdproduct"},{"code":"4004002","system":"gprdproduct"},{"code":"5818009","system":"gprdproduct"},{"code":"2143010","system":"gprdproduct"},{"code":"1882009","system":"gprdproduct"},{"code":"5026009","system":"gprdproduct"},{"code":"5069009","system":"gprdproduct"},{"code":"5014009","system":"gprdproduct"},{"code":"3761009","system":"gprdproduct"},{"code":"881001","system":"gprdproduct"},{"code":"1408011","system":"gprdproduct"},{"code":"848001","system":"gprdproduct"},{"code":"6064001","system":"gprdproduct"},{"code":"3794009","system":"gprdproduct"},{"code":"3009001","system":"gprdproduct"},{"code":"4807009","system":"gprdproduct"},{"code":"5038009","system":"gprdproduct"},{"code":"3974001","system":"gprdproduct"},{"code":"1702001","system":"gprdproduct"},{"code":"6850009","system":"gprdproduct"},{"code":"2863011","system":"gprdproduct"},{"code":"581010","system":"gprdproduct"},{"code":"3680010","system":"gprdproduct"},{"code":"6064003","system":"gprdproduct"},{"code":"4729001","system":"gprdproduct"},{"code":"10341002","system":"gprdproduct"},{"code":"909011","system":"gprdproduct"},{"code":"289011","system":"gprdproduct"},{"code":"1323010","system":"gprdproduct"},{"code":"2897003","system":"gprdproduct"},{"code":"6149009","system":"gprdproduct"},{"code":"880001","system":"gprdproduct"},{"code":"292010","system":"gprdproduct"},{"code":"581009","system":"gprdproduct"},{"code":"1714001","system":"gprdproduct"},{"code":"5046009","system":"gprdproduct"},{"code":"721010","system":"gprdproduct"},{"code":"5817009","system":"gprdproduct"},{"code":"5075009","system":"gprdproduct"},{"code":"1549009","system":"gprdproduct"},{"code":"582009","system":"gprdproduct"},{"code":"3898009","system":"gprdproduct"},{"code":"3996009","system":"gprdproduct"},{"code":"5008009","system":"gprdproduct"},{"code":"5365002","system":"gprdproduct"},{"code":"867001","system":"gprdproduct"},{"code":"5009009","system":"gprdproduct"},{"code":"6064002","system":"gprdproduct"},{"code":"2409003","system":"gprdproduct"},{"code":"1715001","system":"gprdproduct"},{"code":"5695009","system":"gprdproduct"},{"code":"2409001","system":"gprdproduct"},{"code":"4729003","system":"gprdproduct"},{"code":"5040009","system":"gprdproduct"},{"code":"1595001","system":"gprdproduct"},{"code":"580009","system":"gprdproduct"},{"code":"1349010","system":"gprdproduct"},{"code":"4484002","system":"gprdproduct"},{"code":"4004003","system":"gprdproduct"},{"code":"8112001","system":"gprdproduct"},{"code":"5819009","system":"gprdproduct"},{"code":"1856010","system":"gprdproduct"},{"code":"1363010","system":"gprdproduct"},{"code":"910009","system":"gprdproduct"},{"code":"7109001","system":"gprdproduct"},{"code":"2897001","system":"gprdproduct"},{"code":"6113009","system":"gprdproduct"},{"code":"8779001","system":"gprdproduct"},{"code":"288009","system":"gprdproduct"},{"code":"5070002","system":"gprdproduct"},{"code":"2898001","system":"gprdproduct"},{"code":"2899001","system":"gprdproduct"},{"code":"5578009","system":"gprdproduct"},{"code":"1618001","system":"gprdproduct"},{"code":"291009","system":"gprdproduct"},{"code":"5044009","system":"gprdproduct"},{"code":"5532009","system":"gprdproduct"},{"code":"1601001","system":"gprdproduct"},{"code":"5450001","system":"gprdproduct"},{"code":"3028009","system":"gprdproduct"},{"code":"287009","system":"gprdproduct"},{"code":"5077009","system":"gprdproduct"},{"code":"968001","system":"gprdproduct"},{"code":"4348009","system":"gprdproduct"},{"code":"1344009","system":"gprdproduct"},{"code":"2202009","system":"gprdproduct"},{"code":"2842010","system":"gprdproduct"},{"code":"1818009","system":"gprdproduct"},{"code":"5024009","system":"gprdproduct"},{"code":"5216002","system":"gprdproduct"},{"code":"6780002","system":"gprdproduct"},{"code":"1714003","system":"gprdproduct"},{"code":"3150010","system":"gprdproduct"},{"code":"3156010","system":"gprdproduct"},{"code":"3762009","system":"gprdproduct"},{"code":"1201011","system":"gprdproduct"},{"code":"1618003","system":"gprdproduct"},{"code":"2874001","system":"gprdproduct"},{"code":"4496009","system":"gprdproduct"},{"code":"5577009","system":"gprdproduct"},{"code":"4730001","system":"gprdproduct"},{"code":"1714002","system":"gprdproduct"},{"code":"909010","system":"gprdproduct"},{"code":"880002","system":"gprdproduct"},{"code":"6177009","system":"gprdproduct"},{"code":"5721009","system":"gprdproduct"},{"code":"6307003","system":"gprdproduct"},{"code":"14038001","system":"gprdproduct"},{"code":"1618002","system":"gprdproduct"},{"code":"290009","system":"gprdproduct"},{"code":"5045009","system":"gprdproduct"},{"code":"2031011","system":"gprdproduct"},{"code":"2874002","system":"gprdproduct"},{"code":"5035009","system":"gprdproduct"},{"code":"3707010","system":"gprdproduct"},{"code":"2895002","system":"gprdproduct"},{"code":"5364001","system":"gprdproduct"},{"code":"1408009","system":"gprdproduct"},{"code":"12711001","system":"gprdproduct"},{"code":"5449001","system":"gprdproduct"},{"code":"3651010","system":"gprdproduct"},{"code":"3705010","system":"gprdproduct"},{"code":"1201010","system":"gprdproduct"},{"code":"3710010","system":"gprdproduct"},{"code":"1700002","system":"gprdproduct"},{"code":"4729002","system":"gprdproduct"},{"code":"3761011","system":"gprdproduct"},{"code":"540001","system":"gprdproduct"},{"code":"2017009","system":"gprdproduct"},{"code":"6694009","system":"gprdproduct"},{"code":"5820009","system":"gprdproduct"},{"code":"4004001","system":"gprdproduct"},{"code":"2876003","system":"gprdproduct"},{"code":"5317007","system":"gprdproduct"},{"code":"5696009","system":"gprdproduct"},{"code":"2877001","system":"gprdproduct"},{"code":"3075011","system":"gprdproduct"},{"code":"3285010","system":"gprdproduct"},{"code":"4233002","system":"gprdproduct"},{"code":"4732001","system":"gprdproduct"},{"code":"2896001","system":"gprdproduct"},{"code":"5068009","system":"gprdproduct"},{"code":"293010","system":"gprdproduct"},{"code":"3285009","system":"gprdproduct"},{"code":"1700003","system":"gprdproduct"},{"code":"539002","system":"gprdproduct"},{"code":"2842009","system":"gprdproduct"},{"code":"677009","system":"gprdproduct"},{"code":"6790001","system":"gprdproduct"},{"code":"1038002","system":"gprdproduct"},{"code":"5013009","system":"gprdproduct"},{"code":"5575009","system":"gprdproduct"},{"code":"3662010","system":"gprdproduct"},{"code":"2410001","system":"gprdproduct"},{"code":"6308003","system":"gprdproduct"},{"code":"5448001","system":"gprdproduct"},{"code":"2777010","system":"gprdproduct"},{"code":"2876001","system":"gprdproduct"},{"code":"6032009","system":"gprdproduct"},{"code":"5727009","system":"gprdproduct"},{"code":"2875001","system":"gprdproduct"},{"code":"2895003","system":"gprdproduct"},{"code":"1619001","system":"gprdproduct"},{"code":"14040001","system":"gprdproduct"},{"code":"2863009","system":"gprdproduct"},{"code":"4173002","system":"gprdproduct"},{"code":"4337001","system":"gprdproduct"},{"code":"2899003","system":"gprdproduct"},{"code":"2876002","system":"gprdproduct"},{"code":"5366001","system":"gprdproduct"},{"code":"581011","system":"gprdproduct"},{"code":"909009","system":"gprdproduct"},{"code":"722010","system":"gprdproduct"},{"code":"11922001","system":"gprdproduct"},{"code":"2862009","system":"gprdproduct"},{"code":"5037009","system":"gprdproduct"},{"code":"6391001","system":"gprdproduct"},{"code":"498010","system":"gprdproduct"},{"code":"1702002","system":"gprdproduct"},{"code":"5719009","system":"gprdproduct"},{"code":"5036009","system":"gprdproduct"},{"code":"293011","system":"gprdproduct"},{"code":"5042009","system":"gprdproduct"},{"code":"2874003","system":"gprdproduct"},{"code":"2900001","system":"gprdproduct"},{"code":"287010","system":"gprdproduct"},{"code":"2031009","system":"gprdproduct"},{"code":"2897002","system":"gprdproduct"},{"code":"6175009","system":"gprdproduct"},{"code":"1323009","system":"gprdproduct"},{"code":"2895001","system":"gprdproduct"},{"code":"10343003","system":"gprdproduct"},{"code":"5426001","system":"gprdproduct"},{"code":"292009","system":"gprdproduct"},{"code":"1516010","system":"gprdproduct"},{"code":"5034009","system":"gprdproduct"},{"code":"3028011","system":"gprdproduct"},{"code":"4383009","system":"gprdproduct"},{"code":"2777009","system":"gprdproduct"},{"code":"1323011","system":"gprdproduct"},{"code":"2441009","system":"gprdproduct"},{"code":"1517010","system":"gprdproduct"},{"code":"1701001","system":"gprdproduct"},{"code":"291010","system":"gprdproduct"},{"code":"5216003","system":"gprdproduct"},{"code":"2230010","system":"gprdproduct"},{"code":"293009","system":"gprdproduct"},{"code":"5011009","system":"gprdproduct"},{"code":"5039009","system":"gprdproduct"},{"code":"931001","system":"gprdproduct"},{"code":"4732002","system":"gprdproduct"},{"code":"5025009","system":"gprdproduct"},{"code":"4838001","system":"gprdproduct"},{"code":"294009","system":"gprdproduct"},{"code":"5015009","system":"gprdproduct"},{"code":"3059001","system":"gprdproduct"},{"code":"3104010","system":"gprdproduct"},{"code":"1655010","system":"gprdproduct"},{"code":"11637003","system":"gprdproduct"},{"code":"3761010","system":"gprdproduct"},{"code":"6174009","system":"gprdproduct"},{"code":"5694009","system":"gprdproduct"},{"code":"2831010","system":"gprdproduct"},{"code":"2411002","system":"gprdproduct"},{"code":"676009","system":"gprdproduct"},{"code":"2198010","system":"gprdproduct"},{"code":"3650010","system":"gprdproduct"},{"code":"2143009","system":"gprdproduct"},{"code":"580011","system":"gprdproduct"},{"code":"5010009","system":"gprdproduct"},{"code":"580010","system":"gprdproduct"},{"code":"5576009","system":"gprdproduct"},{"code":"10341001","system":"gprdproduct"},{"code":"6308001","system":"gprdproduct"},{"code":"11922003","system":"gprdproduct"},{"code":"4495009","system":"gprdproduct"},{"code":"287011","system":"gprdproduct"},{"code":"1344011","system":"gprdproduct"},{"code":"3675010","system":"gprdproduct"},{"code":"3982009","system":"gprdproduct"},{"code":"10602001","system":"gprdproduct"},{"code":"1698001","system":"gprdproduct"},{"code":"5016009","system":"gprdproduct"},{"code":"6657009","system":"gprdproduct"},{"code":"1183001","system":"gprdproduct"},{"code":"830010","system":"gprdproduct"},{"code":"3317001","system":"gprdproduct"},{"code":"4532009","system":"gprdproduct"},{"code":"6077009","system":"gprdproduct"},{"code":"3316002","system":"gprdproduct"},{"code":"582011","system":"gprdproduct"},{"code":"2259010","system":"gprdproduct"},{"code":"911009","system":"gprdproduct"},{"code":"6693009","system":"gprdproduct"},{"code":"7110001","system":"gprdproduct"},{"code":"6308002","system":"gprdproduct"},{"code":"3007003","system":"gprdproduct"},{"code":"14039001","system":"gprdproduct"},{"code":"1548009","system":"gprdproduct"},{"code":"538001","system":"gprdproduct"},{"code":"6065001","system":"gprdproduct"},{"code":"5076009","system":"gprdproduct"},{"code":"5365001","system":"gprdproduct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('ace-inhibitors-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["ace-inhibitors-tablet---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["ace-inhibitors-tablet---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["ace-inhibitors-tablet---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
